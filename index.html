<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=0.8, user-scalable=no">
  <title>üóíÔ∏è</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1e50c7;
      --primary-rgb: 37, 99, 235;
      --bg-light: #f1f5f9;
      --card-bg: #ffffff;
      --text: #1e293b;
      --border-color: #e2e8f0;
      --white: #ffffff;
      --radius-md: 10px;
      --radius-sm: 6px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
      --error: #dc2626;
      --success: #16a34a;
      --warning: #d97706;
      --info: #0284c7;
      /* Nuevo color para el modo Mover */
      --move-color: #d97706; 
    }
    
    body.dark-mode {
      --bg-light: #131313;
      --card-bg: #333436;
      --text: #f8fafc;
      --border-color: #555555;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    body {
      background: var(--bg-light);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 0;
      transition: all 0.3s;
    }
    
    .main-container {
      max-width: 1400px;
      margin: 1rem auto;
      padding: 0 1rem;
    }
    
    .channels-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.2rem; /* M√°s espacio entre tarjetas */
      width: 100%;
    }
    
    .channel-group {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 0;
      margin-bottom: 1rem;
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }
    
    .channel-group__content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.2rem; /* M√°s espacio entre tarjetas */
      padding: 0.8rem;
      width: 100%;
      box-sizing: border-box;
    }
    
    .channel-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 1rem; /* M√°s padding interno */
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05); /* Nueva sombra sutil */
      transition: all 0.2s;
      position: relative;
      user-select: none;
      min-height: 120px; /* Asegurar una altura m√≠nima elegante */
      width: 100%;
      box-sizing: border-box;
    }
    
    .channel-card:hover {
      transform: scale(1.02); /* Efecto de 'pop-up' sutil */
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
      border-color: var(--primary);
    }
    
    .app-header {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .app-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .header-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .search-filters {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: var(--shadow-sm);
    }
    
    .search-box {
      position: relative;
      margin-bottom: 0.8rem;
    }
    
    .search-box input {
      width: 100%;
      padding: 0.6rem 1rem 0.6rem 2.2rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      background-color: var(--card-bg);
      color: var(--text);
      box-sizing: border-box;
    }
    
    .search-box::before {
      content: "üîç";
      position: absolute;
      left: 0.8rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text);
      font-size: 0.9rem;
    }
    
    .filter-buttons {
      display: flex;
      gap: 0.6rem;
      margin-top: 0.8rem;
    }
    
    .filter-button {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 500;
      transition: all 0.2s;
      white-space: nowrap; /* Evita que el texto se rompa */
    }
    
    .filter-button:hover {
      border-color: var(--primary);
    }
    
    .filter-button--active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* Nuevo estilo para el bot√≥n de Mover */
    .filter-button--move-active {
        background: var(--move-color);
        color: white;
        border-color: var(--move-color);
    }
    
    .filter-button--favorites, .filter-button--clear {
      flex: 0 0 auto;
      width: 36px;
      min-width: 36px;
      padding: 0.5rem 0;
    }
    
    /* Estilo para los botones de texto (Editar, A√±adir) */
    .filter-button--text {
        flex: 1;
        width: auto;
        min-width: unset;
        font-size: 0.9rem; /* Un poco m√°s grandes */
    }

    /* Ajustar los botones de acci√≥n para que tengan un tama√±o similar */
    .filter-buttons > .filter-button {
        flex: 1;
    }
    .filter-buttons > .filter-button--favorites, 
    .filter-buttons > .filter-button--clear {
        flex: 0 0 36px;
    }

    .emoji-filters {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    
    .emoji-filter-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .emoji-filter-btn:hover {
      border-color: var(--primary);
    }
    
    .emoji-filter-btn--active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .channel-card--favorite {
      border: 2px solid var(--primary);
    }
    
    /* 1. Encabezado de la Tarjeta REORGANIZADO */
    .channel-header {
        display: block; 
        text-align: center;
        margin-bottom: 0.2rem;
        padding-top: 1rem; /* Espacio para los nuevos tags superiores */
    }

    .channel-name {
        font-weight: 700; /* M√°s negrita */
        font-size: 1rem; /* T√≠tulo m√°s grande */
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        display: block; 
        gap: 0;
        margin-bottom: 5px;
        color: var(--text);
        padding: 0 0.5rem;
    }

    /* 2. Nuevo Tag de Deporte (en esquina superior izquierda) */
    .channel-sport {
        position: absolute;
        top: 0.5rem;
        left: 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        /* Se convierte en un chip visual */
        background: rgba(var(--primary-rgb), 0.15); 
        color: var(--primary);
        padding: 0.2rem 0.5rem;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        gap: 5px;
        line-height: 1;
    }
    
    /* 3. Etiqueta de Recuento de Enlaces */
    .channel-number {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        background: var(--primary); 
        color: var(--white);
        padding: 0.2rem 0.5rem;
        border-radius: var(--radius-sm);
    }

    /* 4. Idioma (ajustado en tama√±o/posici√≥n) */
    .channel-language {
        position: absolute;
        top: 0.5rem;
        right: 3.8rem; /* Ajustado para dejar espacio al Recuento */
        font-size: 0.75rem;
        background: var(--info); /* Color de Info para distinci√≥n */
        color: var(--white);
        padding: 0.2rem 0.4rem;
        border-radius: var(--radius-sm);
    }
    
    /* 5. Puntuaci√≥n (Rating) */
    .channel-rating {
        position: static; /* Ya no est√° en la esquina inferior */
        text-align: center;
        margin: 0.5rem 0;
        font-size: 1rem; /* Estrellas m√°s grandes */
        color: var(--warning);
    }
    
    /* 6. Nuevo campo: Web de Origen */
    .channel-event {
        font-size: 0.8rem;
        margin-top: 0.5rem;
        text-align: center;
        color: var(--text);
        opacity: 0.8;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
    }
    
    .channel-number {
      color: var(--white);
      font-weight: 600;
      font-size: 0.75rem;
    }
    
    .channel-time {
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .channel-time--live::before, .channel-name--live::before {
      content: "";
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: #dc2626;
      animation: pulse 1.5s infinite;
    }
    
    .player-section {
      position: relative;
    }
    
    .player-container {
      background: black;
      border-radius: var(--radius-md);
      overflow: hidden;
      width: 100%;
      height: 400px;
      display: none;
      position: relative;
      transition: all 0.3s ease;
    }
    
    .player-container--active {
      display: block;
      animation: tvOn 0.5s ease;
    }
    
    .player-container--minimized {
      width: 320px;
      height: 180px;
      position: fixed;
      bottom: 80px;
      right: 20px;
      z-index: 100;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      cursor: move;
    }
    
    #videoFrame {
      width: 100%;
      height: 100%;
      border: none;
      object-fit: cover;
    }
    
    .player-controls {
      display: none;
      gap: 10px;
      justify-content: center;
      padding: 10px;
      background: var(--card-bg);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      position: relative;
      margin-bottom: 10px;
    }
    
    .player-controls--active {
      display: flex;
    }
    
    .player-controls--minimized {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 320px;
      z-index: 100;
      cursor: move;
    }
    
    .control-btn {
      background: var(--primary);
      border: none;
      color: white;
      cursor: pointer;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .control-btn:hover {
      background: var(--primary-dark);
    }
    
    .control-btn--active {
      background: var(--primary-dark);
    }
    
    .channel-info {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.9rem;
      font-weight: 600;
      max-width: 150px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: move;
      user-select: none;
    }
    
    .channel-number-display {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .channel-group__header {
      padding: 0.8rem 1rem;
      background: rgba(var(--primary-rgb), 0.1);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    
    .channel-group__header--collapsed {
      border-bottom: none;
    }
    
    .channel-group__title {
      font-weight: 600;
      color: var(--text);
    }
    
    .channel-group__sport {
      font-size: 0.8rem;
      color: var(--primary);
      margin-top: 0.2rem;
    }
    
    .channel-group__content--collapsed {
      display: none;
    }
    
    .no-results {
      text-align: center;
      padding: 2rem;
      color: var(--text);
      opacity: 0.7;
      font-size: 1.1rem;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal--active {
      display: flex;
    }
    
    .modal-content {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 1.5rem;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      animation: modalFadeIn 0.3s ease;
      border: 1px solid var(--border-color);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 1rem;
    }
    
    .modal-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--text);
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text);
    }
    
    .settings-section {
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .settings-section:last-child {
      border-bottom: none;
    }
    
    .settings-section-title {
      font-weight: 700;
      margin-bottom: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--primary);
    }
    
    .settings-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .settings-option:last-child {
      border-bottom: none;
    }
    
    .settings-option-label {
      flex: 1;
    }
    
    .settings-option-description {
      font-size: 0.8rem;
      color: var(--text);
      opacity: 0.7;
      margin-top: 0.3rem;
    }
    
    .color-picker {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .color-option {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
    }
    
    .color-option--active {
      border-color: var(--text);
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .form-input, .form-select, .json-textarea {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      background: var(--bg-light);
      color: var(--text);
      box-sizing: border-box;
      transition: all 0.2s;
    }
    
    .form-input:focus, .form-select:focus, .json-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 1.5rem;
    }
    
    .btn {
      padding: 0.6rem 1.2rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      font-size: 0.9rem;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
      border: none;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-secondary {
      background: var(--card-bg);
      color: var(--text);
      border: 1px solid var(--border-color);
    }
    
    .btn-secondary:hover {
      border-color: var(--primary);
    }
    
    .btn-danger {
      background: var(--error);
      color: white;
      border: none;
    }
    
    .btn-danger:hover {
      background: #b91c1c;
    }
    
    .import-export-tabs {
      display: flex;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 1rem;
    }
    
    .import-export-tab {
      padding: 0.6rem 1.2rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      font-weight: 500;
      color: var(--text);
    }
    
    .import-export-tab--active {
      border-bottom-color: var(--primary);
      color: var(--primary);
      font-weight: 600;
    }
    
    .import-export-content {
      display: none;
    }
    
    .import-export-content--active {
      display: block;
    }
    
    .json-textarea {
      width: 100%;
      min-height: 200px;
      padding: 0.8rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      background: var(--card-bg);
      color: var(--text);
      font-family: monospace;
      margin-bottom: 1rem;
    }
    
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 0.8rem 1rem;
      border-radius: var(--radius-sm);
      background: var(--card-bg);
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
    }
    
    .notification--success {
      border-left: 4px solid var(--success);
    }
    
    .notification--error {
      border-left: 4px solid var(--error);
    }
    
    .notification--active {
      transform: translateY(0);
      opacity: 1;
    }
    
    .scroll-to-top {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      z-index: 999;
    }
    
    .scroll-to-top--visible {
      opacity: 1;
      visibility: visible;
    }
    
    .star {
      cursor: pointer;
      font-size: 1.5rem;
      color: #ccc;
      transition: color 0.2s;
    }
    
    .star.active {
      color: var(--warning);
    }
    
    .confirm-dialog {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      padding: 1.5rem;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .confirm-dialog p {
      margin-bottom: 1.5rem;
    }
    
    .confirm-dialog-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
    
    .delete-btn {
      position: absolute;
      top: 5px;
      left: 5px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--error);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 10;
      border: none;
      display: none;
    }
    
    .edit-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 10;
      border: none;
      display: none;
    }
    
    .channel-card--edit-mode .delete-btn,
    .channel-card--edit-mode .edit-btn {
      display: flex;
    }
    
    .channel-card--edit-mode:hover .delete-btn,
    .channel-card--edit-mode:hover .edit-btn {
      opacity: 1;
    }
    
    .channel-card--edit-mode {
      cursor: pointer;
      border: 2px dashed var(--primary); /* Estilo de edici√≥n */
      background: rgba(var(--primary-rgb), 0.05); /* Fondo sutil de edici√≥n */
    }

    /* Estilo para el modo Mover/Drag */
    .channel-card--move-mode {
      cursor: grab !important;
      border: 2px dashed var(--move-color) !important; 
      background: rgba(255, 193, 7, 0.05); /* Fondo sutil de advertencia */
    }
    .channel-card--move-mode .delete-btn,
    .channel-card--move-mode .edit-btn {
      display: none; /* Ocultar botones de acci√≥n en modo mover */
    }
    .channel-card--move-mode:hover {
        transform: scale(1.02); 
    }
    .channel-card--dragging {
        opacity: 0.5;
        border: 2px solid var(--move-color) !important;
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    
    .import-gist-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .import-gist-btn:hover {
      background: var(--primary-dark);
    }
    
    .save-edit-btn {
      position: fixed;
      bottom: 120px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--success);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 999;
      border: none;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    
    .save-edit-btn--visible {
      opacity: 1;
      visibility: visible;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 22px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--border-color);
      transition: .4s;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
    }

    input:checked + .slider {
      background-color: var(--primary);
    }

    input:focus + .slider {
      box-shadow: 0 0 1px var(--primary);
    }

    input:checked + .slider:before {
      transform: translateX(18px);
    }

    .slider.round {
      border-radius: 22px;
    }

    .slider.round:before {
      border-radius: 50%;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }
    
    @keyframes tvOn {
      0% { opacity: 0; transform: scale(0.9); }
      100% { opacity: 1; transform: scale(1); }
    }
    
    @keyframes modalFadeIn {
      0% { opacity: 0; transform: translateY(-20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    
    @media (max-width: 768px) {
      .channels-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
      
      .filter-buttons {
        flex-wrap: wrap;
      }
      
      .channel-group__content {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
      
      .channel-group__content .channel-card:last-child:nth-child(3n+1) {
        grid-column: 1 / -1;
      }
      
      .channel-group__content .channel-card:last-child:nth-child(3n+2),
      .channel-group__content .channel-card:nth-last-child(2):nth-child(3n+1) {
        grid-column: span 1;
      }
      
      .channel-info, .channel-number-display {
        position: static;
        transform: none;
        font-size: 0.75rem;
        max-width: 30%;
      }
      
      .channel-info {
        text-align: left;
        flex: 1;
      }
      
      .channel-number-display {
        text-align: right;
        margin-left: auto;
      }
      
      .player-container {
        height: 400px;
      }
      
      .player-container--minimized {
        width: 280px;
        height: 157.5px;
        bottom: 70px;
      }
      
      .player-controls--minimized {
        width: 280px;
      }
    }
    
    @media (min-width: 768px) {
      .channel-name {
        font-size: 1rem;
      }
      
      .channel-event {
        font-size: 0.8rem;
      }
      
      .channel-sport {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    
    <div class="player-section" id="playerSection">
      <div class="player-container" id="playerContainer">
        <iframe id="videoFrame" frameborder="0" allowfullscreen></iframe>
      </div>
      <div class="player-controls" id="playerControls">
        <span class="channel-info" id="channelInfo"></span>
        <button class="control-btn" id="prevChannelBtn" title="Reducir tama√±o">‚ñ≤</button>
        <button class="control-btn" id="nextChannelBtn" title="Aumentar tama√±o">‚ñº</button>
        <button class="control-btn" id="toggleStickyBtn" title="Fijar reproductor">‚õä</button>
        <button class="control-btn" id="favoriteBtn" title="Guardar favorito">‚òÖ</button>
        <button class="control-btn" id="closePlayerBtn" title="Cerrar">√ó</button>
        <span class="channel-number-display" id="channelNumberDisplay"></span>
      </div>
    </div>
    
    <div class="search-filters">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Buscar canales, n√∫mero (ej: #123) o hora (ej: 15:30)">
      </div>
      <div class="filter-buttons">
        <button class="filter-button filter-button--favorites" id="filterFavorites" title="Mostrar solo favoritos">‚òÖ</button>
        <button class="filter-button filter-button--text" id="editLinksBtn" title="Activar modo edici√≥n">Editar</button>
        <button class="filter-button filter-button--text" id="moveLinksBtn" title="Activar modo mover/reordenar">Mover</button>
        <button class="filter-button filter-button--text" id="addLinkBtn" title="A√±adir nuevo enlace">A√±adir</button>
        <button class="filter-button filter-button--clear" id="clearFilters" title="Limpiar filtros (Triple clic para Configuraci√≥n)">x</button>
      </div>
      <div class="emoji-filters" id="emojiFilters">
        <button class="emoji-filter-btn" data-filter="F1" title="F1">üèéÔ∏è</button>
        <button class="emoji-filter-btn" data-filter="F√∫tbol" title="F√∫tbol">‚öΩ</button>
        <button class="emoji-filter-btn" data-filter="Baloncesto" title="Baloncesto">üèÄ</button>
        <button class="emoji-filter-btn" data-filter="Motorsport" title="Motorsport">üèÅ</button>
        <button class="emoji-filter-btn" data-filter="ES" title="Espa√±ol">üá™üá∏</button>
        <button class="emoji-filter-btn" data-filter="EN" title="Ingl√©s">üá¨üáß</button>
      </div>
    </div>
    
    <div id="channelsContent"></div>
    
    <div class="no-results" id="noResults" style="display: none;">
      No se encontraron resultados. Prueba con otros filtros.
    </div>
    
    <button class="save-edit-btn" id="saveEditBtn" title="Guardar cambios">‚úì</button>
    
    <div class="modal" id="settingsModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Configuraci√≥n</h2>
          <button class="modal-close" id="closeSettingsModal">&times;</button>
        </div>
        
        <div class="settings-section">
          <h3 class="settings-section-title">‚öôÔ∏è Preferencias</h3>
          <div class="settings-option">
            <div class="settings-option-label">
              Modo oscuro
              <div class="settings-option-description">Cambia entre tema claro y oscuro</div>
            </div>
            <label class="switch">
              <input type="checkbox" id="darkModeToggle">
              <span class="slider round"></span>
            </label>
          </div>
          <div class="settings-option">
            <div class="settings-option-label">
              Color principal
              <div class="settings-option-description">Personaliza el color de la interfaz</div>
            </div>
            <div class="color-picker">
              <div class="color-option color-option--active" style="background: #2563eb;" data-color="#2563eb"></div>
              <div class="color-option" style="background: #dc2626;" data-color="#dc2626"></div>
              <div class="color-option" style="background: #16a34a;" data-color="#16a34a"></div>
              <div class="color-option" style="background: #d97706;" data-color="#d97706"></div>
              <div class="color-option" style="background: #7c3aed;" data-color="#7c3aed"></div>
              <div class="color-option" style="background: #db2777;" data-color="#db2777"></div>
            </div>
          </div>
        </div>
        
        <div class="settings-section">
          <h3 class="settings-section-title">üìÅ Gesti√≥n de Datos</h3>
          <div class="import-export-tabs">
            <div class="import-export-tab import-export-tab--active" data-tab="export">Exportar</div>
            <div class="import-export-tab" data-tab="import">Importar</div>
            <div class="import-export-tab" data-tab="github">GitHub</div>
          </div>
          
          <div class="import-export-content import-export-content--active" id="exportTab">
            <textarea class="json-textarea" id="exportLinksData" readonly></textarea>
            <button class="btn btn-primary" id="copyExportLinksBtn">Copiar JSON</button>
          </div>
          
          <div class="import-export-content" id="importTab">
            <textarea class="json-textarea" id="importLinksData" placeholder="Pega aqu√≠ el JSON de exportaci√≥n"></textarea>
            <div class="form-actions">
              <button class="btn btn-secondary" id="cancelImportBtn">Cancelar</button>
              <button class="btn btn-primary" id="importLinksBtn">Importar Datos</button>
            </div>
          </div>
          
          <div class="import-export-content" id="githubTab">
            <div class="form-group">
              <p>Importar lista de canales desde un Gist de GitHub:</p>
              <button class="import-gist-btn" id="importGistBtn">Importar desde Gist</button>
            </div>
          </div>
        </div>
        
        <div class="settings-section">
          <h3 class="settings-section-title">üîó Acciones</h3>
          <div class="form-actions">
            <button class="btn btn-danger" id="clearAllBtn">üóëÔ∏è Borrar Todo</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal" id="editLinkModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">‚úèÔ∏è <span id="editModalTitleText">Editar Enlace</span></h2>
          <button class="modal-close" id="closeEditLinkModal">&times;</button>
        </div>
        
        <div class="form-group">
          <label class="form-label">URL del enlace</label>
          <input type="text" class="form-input" id="editLinkUrl" placeholder="https://ejemplo.com/stream">
        </div>
        
        <div class="form-group">
          <label class="form-label">T√≠tulo</label>
          <input type="text" class="form-input" id="editLinkTitle" placeholder="Nombre del canal o evento">
        </div>
        
        <div class="form-group">
          <label class="form-label">Web de origen (opcional)</label>
          <input type="text" class="form-input" id="editWebName" placeholder="Ej: Movistar, DAZN...">
        </div>
        
        <div class="form-group">
          <label class="form-label">Deporte</label>
          <select class="form-select" id="editLinkSport">
            <option value="F1">üèéÔ∏è</option>
            <option value="Baloncesto">üèÄ</option>
            <option value="F√∫tbol">‚öΩ</option>
            <option value="Motorsport">üèÅ</option>
            <option value="Tenis">üéæ</option>
            <option value="TV">üì∫</option>
            <option value="Otros">üèÖ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Color de borde (opcional)</label>
          <input type="color" class="form-input" id="editLinkColor" value="#2563eb">
        </div>

        <div class="form-group">
          <label class="form-label">Color de borde (c√≥digo HEX)</label>
          <input type="text" class="form-input" id="editLinkColorHex" placeholder="Ej: #FF5733">
        </div>
        
        <div class="form-group">
          <label class="form-label">Idioma</label>
          <select class="form-select" id="editLinkLanguage">
            <option value="ES">Espa√±ol üá™üá∏</option>
            <option value="EN">Ingl√©s üá¨üáß</option>
            <option value="OT">Otro üè≥Ô∏è‚Äç‚ößÔ∏è</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Tipo de enlace</label>
          <select class="form-select" id="editLinkType" disabled>
            <option value="source">Fuente</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Abrir en reproductor</label>
          <label class="switch">
            <input type="checkbox" id="editOpenInPlayer">
            <span class="slider round"></span>
          </label>
        </div>
        
        <div class="form-group">
          <label class="form-label">Favorito</label>
          <label class="switch">
            <input type="checkbox" id="editFavorito">
            <span class="slider round"></span>
          </label>
        </div>
        
        <div class="form-group">
          <label class="form-label">Puntuaci√≥n (1-5)</label>
          <div class="rating-stars" id="editRatingStars">
            <span class="star" data-value="1">‚òÖ</span>
            <span class="star" data-value="2">‚òÖ</span>
            <span class="star" data-value="3">‚òÖ</span>
            <span class="star" data-value="4">‚òÖ</span>
            <span class="star" data-value="5">‚òÖ</span>
          </div>
        </div>
        
        <div class="form-actions">
          <button class="btn btn-secondary" id="cancelEditLinkBtn">Cancelar</button>
          <button class="btn btn-primary" id="saveEditLinkBtn">Guardar Cambios</button>
        </div>
      </div>
    </div>
    
    <div class="modal" id="confirmClearModal">
      <div class="confirm-dialog">
        <h3>¬øEst√°s seguro?</h3>
        <p>Esta acci√≥n borrar√° todos los enlaces y la configuraci√≥n. Esta acci√≥n no se puede deshacer.</p>
        <div class="confirm-dialog-buttons">
          <button class="btn btn-secondary" id="cancelClearBtn">Cancelar</button>
          <button class="btn btn-danger" id="confirmClearBtn">Borrar Todo</button>
        </div>
      </div>
    </div>
    
    <div class="modal" id="confirmDeleteModal">
      <div class="confirm-dialog">
        <h3>¬øBorrar este enlace?</h3>
        <p>Esta acci√≥n no se puede deshacer.</p>
        <div class="confirm-dialog-buttons">
          <button class="btn btn-secondary" id="cancelDeleteBtn">Cancelar</button>
          <button class="btn btn-danger" id="confirmDeleteBtn">Borrar</button>
        </div>
      </div>
    </div>
    
    <div class="modal" id="groupLinksModal">
      <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
          <h2 class="modal-title" id="groupLinksModalTitle">Enlaces del Grupo</h2>
          <button class="modal-close" id="closeGroupLinksModal">&times;</button>
        </div>
        <div class="channels-grid" id="groupLinksContainer">
          </div>
      </div>
    </div>
    <div class="notification" id="notification"></div>
    
    <div class="scroll-to-top" id="scrollToTop">‚Üë</div>
  </div>

  <script>
    const state = {
      links: [
        {
          id: '1',
          link: 'https://example.com/stream1',
          title: 'Canal de Prueba',
          webName: 'Fuente Primaria',
          deporte: 'F√∫tbol',
          type: 'source',
          idioma: 'ES',
          color: '#2563eb',
          openInPlayer: true,
          puntuacion: 4,
          favorito: false
        },
        {
          id: '2',
          link: 'https://example.com/stream2',
          title: 'Canal de Prueba',
          webName: 'Fuente Secundaria',
          deporte: 'F√∫tbol',
          type: 'source',
          idioma: 'EN',
          color: '#dc2626',
          openInPlayer: false,
          puntuacion: 3,
          favorito: true
        },
        {
          id: '3',
          link: 'https://example.com/stream3',
          title: 'Otro Canal',
          webName: 'TV General',
          deporte: 'TV',
          type: 'source',
          idioma: 'ES',
          color: '#16a34a',
          openInPlayer: true,
          puntuacion: 5,
          favorito: false
        }
      ],
      settings: {
        darkMode: false,
        primaryColor: '#2563eb',
        playerHeight: 400,
        minimizedPlayerHeight: 180,
        minimizedPlayerWidth: 320,
        expandedGroups: {},
        editMode: false, /* Modo Edici√≥n (borrar/modificar) */
        moveMode: false  /* Modo Mover (reordenar) */
      },
      filters: {
        searchText: '',
        type: 'source',
        sport: null,
        language: null,
        favoritesOnly: false
      },
      currentPlayer: {
        channelId: null,
        isSticky: false,
        isMinimized: false,
        isExpanded: false
      },
      deleteState: {
        linkId: null
      },
      editState: {
        linkId: null,
        isAdding: false /* Nuevo para diferenciar A√±adir/Editar */
      },
      clearButtonState: {
        clickCount: 0,
        lastClickTime: 0
      },
      favoriteButtonState: {
        clickCount: 0,
        lastClickTime: 0
      },
      filterButtonState: {
        lastClickedButton: null,
        clickCount: 0,
        lastClickTime: 0
      },
      dragState: {
        isDragging: false,
        draggedItem: null,
        startIndex: null
      },
      touchState: {
        startX: 0,
        startY: 0
      },
      playerDragState: {
        isDragging: false,
        offsetX: 0,
        offsetY: 0
      }
    };

    const elements = {
      channelsContent: document.getElementById('channelsContent'),
      noResults: document.getElementById('noResults'),
      playerContainer: document.getElementById('playerContainer'),
      playerControls: document.getElementById('playerControls'),
      videoFrame: document.getElementById('videoFrame'),
      channelInfo: document.getElementById('channelInfo'),
      channelNumberDisplay: document.getElementById('channelNumberDisplay'),
      prevChannelBtn: document.getElementById('prevChannelBtn'),
      nextChannelBtn: document.getElementById('nextChannelBtn'),
      toggleStickyBtn: document.getElementById('toggleStickyBtn'),
      favoriteBtn: document.getElementById('favoriteBtn'),
      closePlayerBtn: document.getElementById('closePlayerBtn'),
      searchInput: document.getElementById('searchInput'),
      filterFavorites: document.getElementById('filterFavorites'),
      editLinksBtn: document.getElementById('editLinksBtn'), /* NUEVO */
      moveLinksBtn: document.getElementById('moveLinksBtn'), /* NUEVO */
      addLinkBtn: document.getElementById('addLinkBtn'),   /* NUEVO */
      clearFilters: document.getElementById('clearFilters'),
      emojiFilters: document.getElementById('emojiFilters'),
      settingsModal: document.getElementById('settingsModal'),
      editLinkModal: document.getElementById('editLinkModal'),
      confirmClearModal: document.getElementById('confirmClearModal'),
      confirmDeleteModal: document.getElementById('confirmDeleteModal'),
      cancelClearBtn: document.getElementById('cancelClearBtn'),
      confirmClearBtn: document.getElementById('confirmClearBtn'),
      cancelDeleteBtn: document.getElementById('cancelDeleteBtn'),
      confirmDeleteBtn: document.getElementById('confirmDeleteBtn'),
      clearAllBtn: document.getElementById('clearAllBtn'),
      darkModeToggle: document.getElementById('darkModeToggle'),
      exportLinksData: document.getElementById('exportLinksData'),
      importLinksData: document.getElementById('importLinksData'),
      copyExportLinksBtn: document.getElementById('copyExportLinksBtn'),
      importLinksBtn: document.getElementById('importLinksBtn'),
      importGistBtn: document.getElementById('importGistBtn'),
      cancelImportBtn: document.getElementById('cancelImportBtn'),
      closeSettingsModal: document.getElementById('closeSettingsModal'),
      editLinkUrl: document.getElementById('editLinkUrl'),
      editLinkTitle: document.getElementById('editLinkTitle'),
      editWebName: document.getElementById('editWebName'),
      editLinkSport: document.getElementById('editLinkSport'),
      editLinkLanguage: document.getElementById('editLinkLanguage'),
      editLinkType: document.getElementById('editLinkType'),
      editLinkColor: document.getElementById('editLinkColor'),
      editLinkColorHex: document.getElementById('editLinkColorHex'),
      editOpenInPlayer: document.getElementById('editOpenInPlayer'),
      editFavorito: document.getElementById('editFavorito'),
      editRatingStars: document.getElementById('editRatingStars'),
      saveEditLinkBtn: document.getElementById('saveEditLinkBtn'),
      cancelEditLinkBtn: document.getElementById('cancelEditLinkBtn'),
      closeEditLinkModal: document.getElementById('closeEditLinkModal'),
      importExportTabs: document.querySelectorAll('.import-export-tab'),
      importExportContents: document.querySelectorAll('.import-export-content'),
      notification: document.getElementById('notification'),
      scrollToTop: document.getElementById('scrollToTop'),
      saveEditBtn: document.getElementById('saveEditBtn'),
      playerSection: document.getElementById('playerSection'),
      groupLinksModal: document.getElementById('groupLinksModal'),
      groupLinksModalTitle: document.getElementById('groupLinksModalTitle'),
      groupLinksContainer: document.getElementById('groupLinksContainer'),
      closeGroupLinksModal: document.getElementById('closeGroupLinksModal'),
      editModalTitleText: document.getElementById('editModalTitleText') /* NUEVO */
    };

    function init() {
      loadSettings();
      loadFilters();
      renderChannels();
      setupEventListeners();
      checkScrollPosition();
      window.addEventListener('storage', handleStorageEvent);
      elements.searchInput.value = state.filters.searchText;
      updateEmojiFilterButtons();
      elements.filterFavorites.classList.toggle('filter-button--active', state.filters.favoritesOnly);
      updateEditModeButtons(); /* NUEVO */
    }

    function handleStorageEvent(event) {
      if (event.key === 'daddyLiveHDLinks' || event.key === 'daddyLiveHDSettings' || event.key === 'daddyLiveHDFilters') {
        loadSettings();
        loadFilters();
        renderChannels();
      }
    }

    function loadSettings() {
      const savedSettings = localStorage.getItem('daddyLiveHDSettings');
      if (savedSettings) {
        Object.assign(state.settings, JSON.parse(savedSettings));
      }
      
      const savedLinks = localStorage.getItem('daddyLiveHDLinks');
      if (savedLinks) {
        state.links = JSON.parse(savedLinks).filter(link => link.type === 'source');
      }
      
      if (state.settings.darkMode) {
        document.body.classList.add('dark-mode');
      }
      
      elements.darkModeToggle.checked = state.settings.darkMode;
      
      if (state.settings.primaryColor) {
        updatePrimaryColor(state.settings.primaryColor);
      }
    }
    
    function loadFilters() {
        const savedFilters = localStorage.getItem('daddyLiveHDFilters');
        if (savedFilters) {
            Object.assign(state.filters, JSON.parse(savedFilters));
        }
        state.filters.type = 'source';
    }

    function updatePrimaryColor(color) {
      document.documentElement.style.setProperty('--primary', color);
      const darkerColor = shadeColor(color, -20);
      document.documentElement.style.setProperty('--primary-dark', darkerColor);
      
      const rgb = hexToRgb(color);
      if (rgb) {
        document.documentElement.style.setProperty('--primary-rgb', `${rgb.r}, ${rgb.g}, ${rgb.b}`);
      }
      
      document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.remove('color-option--active');
        if (opt.dataset.color === color) {
          opt.classList.add('color-option--active');
        }
      });
    }

    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : null;
    }

    function saveSettings() {
      localStorage.setItem('daddyLiveHDSettings', JSON.stringify(state.settings));
      localStorage.setItem('daddyLiveHDLinks', JSON.stringify(state.links.filter(link => link.type === 'source')));
      saveFilters();
    }
    
    function saveFilters() {
        state.filters.type = 'source';
        localStorage.setItem('daddyLiveHDFilters', JSON.stringify(state.filters));
    }

    function clearAllData() {
      state.links = [];
      state.settings = {
        darkMode: false,
        primaryColor: '#2563eb',
        playerHeight: 400,
        minimizedPlayerHeight: 180,
        minimizedPlayerWidth: 320,
        expandedGroups: {},
        editMode: false,
        moveMode: false
      };
      
      localStorage.removeItem('daddyLiveHDSettings');
      localStorage.removeItem('daddyLiveHDLinks');
      localStorage.removeItem('daddyLiveHDFilters');
      
      document.body.classList.remove('dark-mode');
      elements.darkModeToggle.checked = false;
      updatePrimaryColor('#2563eb');
      
      state.filters = {
        searchText: '',
        type: 'source',
        sport: null,
        language: null,
        favoritesOnly: false
      };
      
      elements.searchInput.value = '';
      updateEmojiFilterButtons();
      elements.filterFavorites.classList.remove('filter-button--active');
      
      closePlayer();
      renderChannels();
      updateEditModeButtons(); /* NUEVO */
      
      showNotification('Todos los datos han sido borrados');
    }

    function deleteLink(linkId) {
      state.links = state.links.filter(link => link.id !== linkId);
      saveSettings();
      renderChannels();
      showNotification('Enlace eliminado');
    }

    function renderChannels() {
      const filteredLinks = state.links.filter(link => {
        if (link.type !== 'source') {
             return false;
        }

        if (state.filters.searchText) {
          const searchLower = state.filters.searchText.toLowerCase();
          const searchableText = `${link.title} ${link.webName} ${link.deporte} ${link.idioma}`.toLowerCase();
          
          if (!searchableText.includes(searchLower)) {
            return false;
          }
        }
        
        if (state.filters.sport) {
          if (link.deporte !== state.filters.sport && link.deporte !== 'Otros') {
            return false;
          }
        }
        
        if (state.filters.language && link.idioma !== state.filters.language) {
          return false;
        }
        
        if (state.filters.favoritesOnly && !link.favorito) {
          return false;
        }
        
        return true;
      });
      
      const linksByTitle = {};
      filteredLinks.forEach(link => {
        if (!linksByTitle[link.title]) {
          linksByTitle[link.title] = [];
        }
        linksByTitle[link.title].push(link);
      });
      
      let html = '';
      
      if (Object.keys(linksByTitle).length === 0) {
        elements.noResults.style.display = 'block';
        elements.channelsContent.innerHTML = '';
        return;
      }
      
      elements.noResults.style.display = 'none';
      
      elements.channelsContent.className = 'channels-grid';

      for (const [title, links] of Object.entries(linksByTitle)) {
        const groupId = `group-${title.replace(/\s+/g, '-').toLowerCase()}`;
        const mainLink = links[0];
        const isFavorite = links.some(link => link.favorito);
        
        let languageTag = '';
        if (mainLink.idioma) {
            const languageFlag = mainLink.idioma === 'ES' ? 'üá™üá∏' : mainLink.idioma === 'EN' ? 'üá¨üáß' : 'üè≥Ô∏è‚Äç‚ößÔ∏è';
            languageTag = `<span class="channel-language">${languageFlag}</span>`;
        }
        
        let editModeClass = '';
        if (state.settings.editMode) {
            editModeClass = 'channel-card--edit-mode';
        } else if (state.settings.moveMode) {
            editModeClass = 'channel-card--move-mode';
        }

        html += `
          <div class="channel-card ${isFavorite ? 'channel-card--favorite' : ''} ${editModeClass}" 
               data-group-id="${groupId}" 
               data-group-title="${title}"
               data-links='${JSON.stringify(links)}'
               data-id="${mainLink.id}"
               draggable="${state.settings.moveMode ? 'true' : 'false'}"
               style="${mainLink.color ? `border-color: ${mainLink.color}` : ''}">
            <button class="delete-btn" data-id="${mainLink.id}" title="Borrar enlace principal">√ó</button>
            <button class="edit-btn" data-id="${mainLink.id}" title="Editar enlace principal">‚úèÔ∏è</button>
            
            <div class="channel-sport">${getSportEmoji(mainLink.deporte)}</div>
            
            <span class="channel-number">#${links.length}</span>
            
            ${languageTag}
            
            <div class="channel-header">
              <div class="channel-name">${title}</div>
            </div>
            
            ${mainLink.puntuacion ? `<div class="channel-rating">${'‚òÖ'.repeat(mainLink.puntuacion)}${'‚òÜ'.repeat(5 - mainLink.puntuacion)}</div>` : ''}

            ${mainLink.webName ? `<div class="channel-event">Fuente: ${mainLink.webName}</div>` : `<div class="channel-event">Ver Enlaces</div>`}

          </div>
        `;
      }
      
      elements.channelsContent.innerHTML = html;
      
      if (state.settings.editMode || state.settings.moveMode) {
        setupEditMode();
        elements.saveEditBtn.classList.add('save-edit-btn--visible');
      } else {
        elements.saveEditBtn.classList.remove('save-edit-btn--visible');
      }
      
      document.querySelectorAll('.channel-card[data-group-id]').forEach(groupCard => {
          groupCard.removeEventListener('click', handleGroupCardClick);
          groupCard.addEventListener('click', handleGroupCardClick);

          // L√≥gica de Drag & Drop para modo Mover
          if (state.settings.moveMode) {
              groupCard.addEventListener('dragstart', handleDragStart);
              groupCard.addEventListener('dragover', handleDragOver);
              groupCard.addEventListener('dragleave', handleDragLeave);
              groupCard.addEventListener('drop', handleDrop);
              groupCard.addEventListener('dragend', handleDragEnd);
          } else {
              groupCard.removeEventListener('dragstart', handleDragStart);
              groupCard.removeEventListener('dragover', handleDragOver);
              groupCard.removeEventListener('dragleave', handleDragLeave);
              groupCard.removeEventListener('drop', handleDrop);
              groupCard.removeEventListener('dragend', handleDragEnd);
          }
      });
    }

    function handleDragStart(e) {
        if (!state.settings.moveMode) return;
        
        const draggedCard = e.target.closest('.channel-card[data-group-id]');
        if (!draggedCard) return;

        state.dragState.draggedItem = draggedCard;
        state.dragState.startIndex = Array.from(elements.channelsContent.children).indexOf(draggedCard);
        
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', draggedCard.dataset.id);
        
        setTimeout(() => {
            draggedCard.classList.add('channel-card--dragging');
        }, 0);
    }

    function handleDragOver(e) {
        if (!state.settings.moveMode) return;
        e.preventDefault(); 
        e.dataTransfer.dropEffect = 'move';

        const dropTarget = e.target.closest('.channel-card[data-group-id]');
        const draggedCard = state.dragState.draggedItem;

        if (dropTarget && draggedCard && dropTarget !== draggedCard) {
            const rect = dropTarget.getBoundingClientRect();
            const center = (rect.top + rect.bottom) / 2;
            const channelsContent = elements.channelsContent;

            if (e.clientY < center) {
                channelsContent.insertBefore(draggedCard, dropTarget);
            } else {
                channelsContent.insertBefore(draggedCard, dropTarget.nextSibling);
            }
        }
    }

    function handleDragLeave(e) {
        if (!state.settings.moveMode) return;
        e.target.closest('.channel-card[data-group-id]')?.classList.remove('drag-over');
    }

    function handleDrop(e) {
        if (!state.settings.moveMode) return;
        e.preventDefault();
        
        const dropTarget = e.target.closest('.channel-card[data-group-id]');
        if (dropTarget) {
            dropTarget.classList.remove('drag-over');
        }
        
        // La reordenaci√≥n visual ya se hizo en handleDragOver. 
        // Ahora actualizamos el array state.links
        const newOrderIds = Array.from(elements.channelsContent.children)
            .map(card => card.dataset.id)
            .filter(id => id); // Filtrar solo los IDs de las tarjetas de grupo
        
        const newLinks = [];
        const linksMap = new Map(state.links.map(link => [link.id, link]));
        
        // Reconstruir el array de enlaces en el nuevo orden
        newOrderIds.forEach(id => {
            // Encontrar todos los enlaces que pertenecen a este grupo principal (usando el ID del enlace principal como referencia)
            const mainLink = linksMap.get(id);
            if (mainLink) {
                const groupLinks = state.links.filter(link => link.title === mainLink.title);
                groupLinks.forEach(link => {
                    if (!newLinks.includes(link)) {
                        newLinks.push(link);
                    }
                });
            }
        });
        
        // Agregar cualquier enlace que no est√© en los grupos principales (aunque en el renderChannels actual todos lo est√°n)
        state.links.forEach(link => {
            if (!newLinks.includes(link)) {
                newLinks.push(link);
            }
        });

        state.links = newLinks;
    }

    function handleDragEnd(e) {
        if (!state.settings.moveMode) return;
        state.dragState.draggedItem?.classList.remove('channel-card--dragging');
        state.dragState.draggedItem = null;
        state.dragState.startIndex = null;
        
        saveSettings();
        renderChannels();
        showNotification('Orden de canales actualizado');
    }

    function handleGroupCardClick(e) {
        const groupCard = e.target.closest('.channel-card[data-group-id]');
        if (!groupCard) return;

        if (state.settings.editMode || state.settings.moveMode) {
            // Permitir que el clic pase a los botones delete/edit/drag
            if (e.target.closest('.delete-btn') || e.target.closest('.edit-btn')) {
                return; 
            }
            if (state.settings.moveMode) {
                 // Bloquear la apertura del modal en modo mover
                 return;
            }
            
        }

        const title = groupCard.dataset.groupTitle;
        const linksData = state.links.filter(link => link.title === title);

        elements.groupLinksModalTitle.textContent = `Enlaces de: ${title}`;
        
        elements.groupLinksContainer.innerHTML = linksData.map(link => 
            renderLinkCard(link, true, state.settings.editMode)
        ).join('');

        elements.groupLinksContainer.querySelectorAll('.channel-card[data-id]').forEach(linkCard => {
            linkCard.addEventListener('click', function(e) {
                e.stopPropagation(); 
                
                if (state.settings.editMode) return; // Permitir que los botones delete/edit manejen el click
                
                if (e.target.closest('.delete-btn') || e.target.closest('.edit-btn')) {
                    return; 
                }
                
                const linkId = this.dataset.id;
                openLink(linkId);
                elements.groupLinksModal.classList.remove('modal--active');
            });
        });
        
        elements.groupLinksContainer.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                state.deleteState.linkId = this.dataset.id;
                elements.confirmDeleteModal.classList.add('modal--active');
            });
        });

        elements.groupLinksContainer.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                editLink(this.dataset.id);
            });
        });

        elements.groupLinksModal.classList.add('modal--active');
        
        if (state.settings.editMode) {
            setupEditModeInModal();
        }
    }

    function closeGroupLinksModal() {
        elements.groupLinksModal.classList.remove('modal--active');
    }
    
    function setupEditModeInModal() {
        elements.groupLinksContainer.querySelectorAll('.channel-card[data-id]').forEach(card => {
            card.classList.add('channel-card--edit-mode');
            card.classList.remove('channel-card--move-mode');
            card.setAttribute('draggable', 'false');
        });
    }

    function renderLinkCard(link, isModal = false, isEditMode = false) { 
      const editModeClass = (isEditMode || (state.settings.editMode && isModal)) ? 'channel-card--edit-mode' : '';
      const languageFlag = link.idioma === 'ES' ? 'üá™üá∏' : link.idioma === 'EN' ? 'üá¨üáß' : 'üè≥Ô∏è‚Äç‚ößÔ∏è';
      
      return `
        <div class="channel-card ${link.favorito ? 'channel-card--favorite' : ''} ${editModeClass}" 
             data-id="${link.id}"
             style="${link.color ? `border-color: ${link.color}` : ''}">
          <button class="delete-btn" data-id="${link.id}" title="Borrar enlace">√ó</button>
          <button class="edit-btn" data-id="${link.id}" title="Editar enlace">‚úèÔ∏è</button>
          
          <div class="channel-sport">${getSportEmoji(link.deporte)} ${link.webName || 'Enlace'}</div> 
          
          ${link.idioma ? `<span class="channel-language">${languageFlag}</span>` : ''}

          <div class="channel-header">
            <div class="channel-name">${link.title}</div> 
          </div>
          
          ${link.puntuacion ? `<div class="channel-rating">${'‚òÖ'.repeat(link.puntuacion)}${'‚òÜ'.repeat(5 - link.puntuacion)}</div>` : ''}
          
          <div class="channel-event">
            ${link.openInPlayer ? 'Reproductor interno üé¨' : 'Abrir en nueva pesta√±a ‚ÜóÔ∏è'}
          </div>

        </div>
      `;
    }

    function setupEditMode() {
      const channelCards = document.querySelectorAll('.channel-card');
      
      channelCards.forEach(card => {
        card.classList.remove('channel-card--edit-mode');
        card.classList.remove('channel-card--move-mode');
        card.setAttribute('draggable', 'false');

        if (state.settings.editMode) {
             card.classList.add('channel-card--edit-mode');
        } else if (state.settings.moveMode) {
             card.classList.add('channel-card--move-mode');
             card.setAttribute('draggable', 'true');
        }
      });
    }

    function getTypeDisplay(type) {
      return 'Fuente';
    }

    function getSportEmoji(sport) {
      const emojis = {
        'F1': 'üèéÔ∏è',
        'Baloncesto': 'üèÄ',
        'F√∫tbol': '‚öΩ',
        'Motorsport': 'üèÅ',
        'Tenis': 'üéæ',
        'TV': 'üì∫',
        'Otros': 'üèÖ'
      };
      return emojis[sport] || '';
    }

    function openLink(linkId) {
      if (state.settings.editMode || state.settings.moveMode) return;
      
      const link = state.links.find(l => l.id === linkId);
      if (!link) return;
      
      if (link.openInPlayer) {
        state.currentPlayer.channelId = linkId;
        
        elements.channelInfo.textContent = link.title;
        elements.favoriteBtn.classList.toggle('control-btn--active', link.favorito);
        
        elements.videoFrame.src = link.link;
        
        elements.playerContainer.classList.add('player-container--active');
        elements.playerControls.classList.add('player-controls--active');
        elements.playerSection.scrollIntoView({ behavior: 'smooth' });
        
        if (state.currentPlayer.isMinimized) {
          elements.playerContainer.style.height = `${state.settings.minimizedPlayerHeight}px`;
          elements.playerContainer.style.width = `${state.settings.minimizedPlayerWidth}px`;
        } else {
          elements.playerContainer.style.height = `${state.settings.playerHeight}px`;
          elements.playerContainer.style.width = '100%';
        }
      } else {
        window.open(link.link, '_blank');
      }
    }

    function closePlayer() {
      elements.playerContainer.classList.remove('player-container--active');
      elements.playerControls.classList.remove('player-controls--active');
      state.currentPlayer.channelId = null;
      
      if (state.currentPlayer.isMinimized) {
        toggleMinimizePlayer();
      }
    }

    function toggleMinimizePlayer() {
      state.currentPlayer.isMinimized = !state.currentPlayer.isMinimized;
      
      if (state.currentPlayer.isMinimized) {
        elements.playerContainer.classList.add('player-container--minimized');
        elements.playerControls.classList.add('player-controls--minimized');
        elements.toggleStickyBtn.classList.add('control-btn--active');
        
        elements.playerContainer.style.height = `${state.settings.minimizedPlayerHeight}px`;
        elements.playerContainer.style.width = `${state.settings.minimizedPlayerWidth}px`;
      } else {
        elements.playerContainer.classList.remove('player-container--minimized');
        elements.playerControls.classList.remove('player-controls--minimized');
        elements.toggleStickyBtn.classList.remove('control-btn--active');
        
        elements.playerContainer.style.height = `400px`;
        elements.playerContainer.style.width = '100%';
      }
      
      saveSettings();
    }

    function toggleFavorite() {
      if (!state.currentPlayer.channelId) return;
      
      const link = state.links.find(l => l.id === state.currentPlayer.channelId);
      if (link) {
        link.favorito = !link.favorito;
        elements.favoriteBtn.classList.toggle('control-btn--active', link.favorito);
        
        const linkCard = document.querySelector(`.channel-card[data-id="${link.id}"]`) || 
                         document.querySelector(`.channel-card[data-group-title="${link.title}"]`);
        
        if (linkCard) {
          linkCard.classList.toggle('channel-card--favorite', link.favorito);
        }
        
        showNotification(link.favorito ? 'A√±adido a favoritos' : 'Eliminado de favoritos');
        saveSettings();
        renderChannels();
      }
    }

    function resizePlayer(direction) {
      if (!elements.playerContainer.classList.contains('player-container--active')) return;
      
      if (state.currentPlayer.isMinimized) {
        const currentHeight = elements.playerContainer.offsetHeight;
        const currentWidth = elements.playerContainer.offsetWidth;
        const minHeight = 120;
        const maxHeight = 300;
        const step = 20;
        
        let newHeight, newWidth;
        
        if (direction === 'increase') {
          newHeight = Math.min(currentHeight + step, maxHeight);
          newWidth = Math.round(newHeight * 16/9);
        } else {
          newHeight = Math.max(currentHeight - step, minHeight);
          newWidth = Math.round(newHeight * 16/9);
        }
        
        elements.playerContainer.style.height = `${newHeight}px`;
        elements.playerContainer.style.width = `${newWidth}px`;
      } else {
        const currentHeight = elements.playerContainer.offsetHeight;
        const minHeight = 311;
        const maxHeight = window.innerHeight * 0.85;
        const step = 50;
        
        let newHeight;
        
        if (direction === 'increase') {
          newHeight = Math.min(currentHeight + step, maxHeight);
        } else {
          newHeight = Math.max(currentHeight - step, minHeight);
        }
        
        elements.playerContainer.style.height = `${newHeight}px`;
      }
      
      saveSettings();
    }

    function showNotification(message, type = 'success') {
      elements.notification.textContent = message;
      elements.notification.className = `notification notification--${type}`;
      elements.notification.classList.add('notification--active');
      
      setTimeout(() => {
        elements.notification.classList.remove('notification--active');
      }, 3000);
    }

    function checkScrollPosition() {
      if (window.scrollY > 300) {
        elements.scrollToTop.classList.add('scroll-to-top--visible');
      } else {
        elements.scrollToTop.classList.remove('scroll-to-top--visible');
      }
    }

    function editLink(linkId) {
      const link = state.links.find(l => l.id === linkId);
      if (!link) return;
      
      state.editState.linkId = linkId;
      state.editState.isAdding = false;
      
      elements.editModalTitleText.textContent = 'Editar Enlace';
      
      elements.editLinkUrl.value = link.link;
      elements.editLinkTitle.value = link.title;
      elements.editWebName.value = link.webName || '';
      elements.editLinkSport.value = link.deporte;
      elements.editLinkLanguage.value = link.idioma;
      elements.editLinkType.value = 'source';
      elements.editLinkColor.value = link.color || '#2563eb';
      elements.editLinkColorHex.value = (link.color || '').toUpperCase();
      elements.editOpenInPlayer.checked = link.openInPlayer || false;
      elements.editFavorito.checked = link.favorito || false;
      
      const stars = elements.editRatingStars.querySelectorAll('.star');
      stars.forEach(star => {
        star.classList.remove('active');
      });
      
      for (let i = 0; i < (link.puntuacion || 0); i++) {
        if (stars[i]) {
          stars[i].classList.add('active');
        }
      }
      
      elements.editLinkModal.classList.add('modal--active');
    }

    function saveEditedLink() {
      if (!elements.editLinkUrl.value || !elements.editLinkTitle.value) {
        showNotification('URL y t√≠tulo son obligatorios', 'error');
        return;
      }
      
      if (state.editState.isAdding) {
          addNewLink();
          return;
      }
      
      const link = state.links.find(l => l.id === state.editState.linkId);
      if (!link) return;
      
      const activeStars = elements.editRatingStars.querySelectorAll('.star.active');
      const rating = activeStars.length;

      const newColor = elements.editLinkColorHex.value || elements.editLinkColor.value;
      if (!isValidHexColor(newColor)) {
          showNotification('C√≥digo de color HEX no v√°lido', 'error');
          return;
      }
      
      link.link = elements.editLinkUrl.value;
      link.title = elements.editLinkTitle.value;
      link.webName = elements.editWebName.value || null;
      link.deporte = elements.editLinkSport.value;
      link.idioma = elements.editLinkLanguage.value;
      link.type = 'source'; 
      link.color = newColor.toUpperCase();
      link.openInPlayer = elements.editOpenInPlayer.checked;
      link.favorito = elements.editFavorito.checked;
      link.puntuacion = rating;
      
      saveSettings();
      renderChannels();
      closeEditLinkModal();
      showNotification('Enlace actualizado correctamente');
    }

    function addNewLink() {
      if (!elements.editLinkUrl.value || !elements.editLinkTitle.value) {
        showNotification('URL y t√≠tulo son obligatorios', 'error');
        return;
      }
      
      const activeStars = elements.editRatingStars.querySelectorAll('.star.active');
      const rating = activeStars.length;
      
      const newColor = elements.editLinkColorHex.value || elements.editLinkColor.value;
      if (!isValidHexColor(newColor)) {
          showNotification('C√≥digo de color HEX no v√°lido', 'error');
          return;
      }

      const newLink = {
        id: generateShortId(),
        link: elements.editLinkUrl.value,
        title: elements.editLinkTitle.value,
        webName: elements.editWebName.value || null,
        deporte: elements.editLinkSport.value,
        type: 'source',
        idioma: elements.editLinkLanguage.value,
        color: newColor.toUpperCase(),
        openInPlayer: elements.editOpenInPlayer.checked,
        puntuacion: rating,
        favorito: elements.editFavorito.checked
      };
      
      state.links.push(newLink);
      saveSettings();
      renderChannels();
      closeEditLinkModal();
      showNotification('Nuevo enlace a√±adido');
    }

    function handleClearFiltersClick() {
      const now = Date.now();
      
      if (now - state.clearButtonState.lastClickTime > 1000) {
        state.clearButtonState.clickCount = 0;
      }
      
      state.clearButtonState.clickCount++;
      state.clearButtonState.lastClickTime = now;
      
      if (state.clearButtonState.clickCount >= 3) {
        elements.exportLinksData.value = JSON.stringify(state.links, null, 2);
        elements.settingsModal.classList.add('modal--active');
        state.clearButtonState.clickCount = 0;
      } else {
        state.filters = {
          searchText: '',
          type: 'source',
          sport: null,
          language: null,
          favoritesOnly: false
        };
        
        elements.searchInput.value = '';
        updateEmojiFilterButtons();
        elements.filterFavorites.classList.remove('filter-button--active');
        
        saveFilters();
        renderChannels();
      }
    }
    
    function handleFavoriteButtonClick(event) {
        event.stopPropagation();
        
        // El bot√≥n Favoritos ahora solo maneja los filtros de favoritos.
        
        state.filters.favoritesOnly = !state.filters.favoritesOnly;
        event.target.classList.toggle('filter-button--active', state.filters.favoritesOnly);
        saveFilters();
        renderChannels();
    }
    
    /* FUNCIONES NUEVAS */
    function updateEditModeButtons() {
        // Modo Edici√≥n
        elements.editLinksBtn.classList.toggle('filter-button--active', state.settings.editMode);
        
        // Modo Mover
        elements.moveLinksBtn.classList.toggle('filter-button--move-active', state.settings.moveMode);

        // Si alg√∫n modo de edici√≥n est√° activo, desactiva el filtro de favoritos
        if (state.settings.editMode || state.settings.moveMode) {
             state.filters.favoritesOnly = false;
             elements.filterFavorites.classList.remove('filter-button--active');
        }
    }

    function handleEditClick(event) {
        event.stopPropagation();
        
        state.settings.editMode = !state.settings.editMode;
        state.settings.moveMode = false; // Desactivar modo mover
        
        updateEditModeButtons();
        saveSettings();
        renderChannels();
        
        showNotification('Modo edici√≥n ' + (state.settings.editMode ? 'activado' : 'desactivado'));
    }

    function handleMoveClick(event) {
        event.stopPropagation();
        
        state.settings.moveMode = !state.settings.moveMode;
        state.settings.editMode = false; // Desactivar modo edici√≥n
        
        updateEditModeButtons();
        saveSettings();
        renderChannels();
        
        showNotification('Modo mover ' + (state.settings.moveMode ? 'activado' : 'desactivado'));
    }

    function handleAddClick(event) {
        event.stopPropagation();
        
        state.editState.linkId = null;
        state.editState.isAdding = true;
        
        elements.editModalTitleText.textContent = 'A√±adir Nuevo Enlace';
        
        // Limpiar formulario para un nuevo enlace
        elements.editLinkUrl.value = '';
        elements.editLinkTitle.value = '';
        elements.editWebName.value = '';
        elements.editLinkSport.value = 'F√∫tbol';
        elements.editLinkLanguage.value = 'ES';
        elements.editLinkType.value = 'source';
        elements.editLinkColor.value = '#2563eb';
        elements.editOpenInPlayer.checked = false;
        elements.editFavorito.checked = false;
        elements.editLinkColorHex.value = '';
        
        elements.editRatingStars.querySelectorAll('.star').forEach(star => {
          star.classList.remove('active');
        });
        
        elements.editLinkModal.classList.add('modal--active');
    }
    /* FIN FUNCIONES NUEVAS */


    async function importFromGist() {
      try {
        const gistId = 'be82cec2fed5b9886b07fc171f2d9744';
        const rawUrl = `https://gist.githubusercontent.com/Ciento20/${gistId}/raw`;
        
        const response = await fetch(rawUrl);
        if (!response.ok) {
          throw new Error('Error al obtener los datos del Gist');
        }
        
        const data = await response.json();
        if (!Array.isArray(data)) {
          throw new Error('Los datos del Gist no son v√°lidos');
        }
        
        const normalizedData = data.map(item => ({
          id: generateShortId(),
          link: item.link || item.url || '',
          title: item.title || item.name || 'Sin t√≠tulo',
          webName: item.webName || item.source || null,
          deporte: item.deporte || item.sport || 'Otros',
          type: 'source',
          idioma: item.idioma || item.language || 'ES',
          color: (item.color || '#2563eb').toUpperCase(),
          openInPlayer: item.openInPlayer || false,
          puntuacion: item.puntuacion || item.rating || 3,
          favorito: item.favorito || false
        })).filter(item => item.link && item.type === 'source');
        
        if (normalizedData.length === 0) {
          showNotification('El Gist no contiene enlaces v√°lidos de tipo "Fuente"', 'error');
          return;
        }
        
        state.links = normalizedData;
        saveSettings();
        renderChannels();
        closeSettingsModal();
        showNotification(`Se importaron ${normalizedData.length} enlaces desde el Gist`);
      } catch (error) {
        showNotification(`Error al importar desde Gist: ${error.message}`, 'error');
        console.error('Error al importar desde Gist:', error);
      }
    }

    function generateShortId() {
      return Math.random().toString(36).substr(2, 9);
    }

    function setupPlayerDrag() {
      const playerContainer = elements.playerContainer;
      const playerControls = elements.playerControls;
      const channelInfo = elements.channelInfo;
      
      function startDrag(e) {
        if (!state.currentPlayer.isMinimized) return;
        
        state.playerDragState.isDragging = true;
        
        const rect = playerContainer.getBoundingClientRect();
        state.playerDragState.offsetX = e.clientX - rect.left;
        state.playerDragState.offsetY = e.clientY - rect.top;
        
        playerContainer.style.cursor = 'grabbing';
        playerControls.style.cursor = 'grabbing';
        channelInfo.style.cursor = 'grabbing';
        
        e.preventDefault();
      }
      
      function drag(e) {
        if (!state.playerDragState.isDragging) return;
        
        e.preventDefault();
        
        let clientX = e.clientX || e.touches[0].clientX;
        let clientY = e.clientY || e.touches[0].clientY;
        
        let x = clientX - state.playerDragState.offsetX;
        let y = clientY - state.playerDragState.offsetY;
        
        const maxX = window.innerWidth - playerContainer.offsetWidth;
        const maxY = window.innerHeight - playerContainer.offsetHeight;
        
        x = Math.max(0, Math.min(x, maxX));
        y = Math.max(0, Math.min(y, maxY));
        
        playerContainer.style.left = `${x}px`;
        playerContainer.style.top = `${y}px`;
        playerControls.style.left = `${x}px`;
        playerControls.style.bottom = `${window.innerHeight - y - playerContainer.offsetHeight - 60}px`;
      }
      
      function endDrag() {
        if (!state.playerDragState.isDragging) return;
        
        state.playerDragState.isDragging = false;
        playerContainer.style.cursor = 'move';
        playerControls.style.cursor = 'move';
        channelInfo.style.cursor = 'move';
      }
      
      channelInfo.addEventListener('mousedown', startDrag);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', endDrag);
      
      channelInfo.addEventListener('touchstart', function(e) {
        startDrag(e.touches[0]);
      }, { passive: false });
      
      document.addEventListener('touchmove', function(e) {
        drag(e);
      }, { passive: false });
      
      document.addEventListener('touchend', endDrag);
    }

    function isValidHexColor(hex) {
        return /(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(hex);
    }

    function setupEventListeners() {
      setupPlayerDrag();
      
      document.addEventListener('click', function(e) {
        const deleteBtn = e.target.closest('.delete-btn');
        if (deleteBtn) {
          e.stopPropagation();
          state.deleteState.linkId = deleteBtn.dataset.id;
          elements.confirmDeleteModal.classList.add('modal--active');
          return;
        }
        
        const editBtn = e.target.closest('.edit-btn');
        if (editBtn) {
          e.stopPropagation();
          editLink(editBtn.dataset.id);
          return;
        }
      });
      
      elements.closeGroupLinksModal.addEventListener('click', closeGroupLinksModal);
      
      elements.cancelDeleteBtn.addEventListener('click', function() {
        elements.confirmDeleteModal.classList.remove('modal--active');
      });
      
      elements.confirmDeleteBtn.addEventListener('click', function() {
        elements.confirmDeleteModal.classList.remove('modal--active');
        if (state.deleteState.linkId) {
          deleteLink(state.deleteState.linkId);
          closeGroupLinksModal();
        }
      });
      
      elements.prevChannelBtn.addEventListener('click', () => resizePlayer('decrease'));
      elements.nextChannelBtn.addEventListener('click', () => resizePlayer('increase'));
      elements.toggleStickyBtn.addEventListener('click', toggleMinimizePlayer);
      elements.favoriteBtn.addEventListener('click', toggleFavorite);
      elements.closePlayerBtn.addEventListener('click', closePlayer);
      
      elements.searchInput.addEventListener('input', function() {
        state.filters.searchText = this.value;
        saveFilters();
        renderChannels();
      });
      
      elements.filterFavorites.addEventListener('click', handleFavoriteButtonClick);
      
      elements.editLinksBtn.addEventListener('click', handleEditClick); /* NUEVO */
      elements.moveLinksBtn.addEventListener('click', handleMoveClick); /* NUEVO */
      elements.addLinkBtn.addEventListener('click', handleAddClick);   /* NUEVO */
      
      elements.clearFilters.addEventListener('click', handleClearFiltersClick);
      
      elements.emojiFilters.addEventListener('click', function(e) {
        const emojiBtn = e.target.closest('.emoji-filter-btn');
        if (emojiBtn) {
          const filterType = emojiBtn.dataset.filter;
          
          if (filterType === 'ES' || filterType === 'EN') {
            if (state.filters.language === filterType) {
              state.filters.language = null;
            } else {
              state.filters.language = filterType;
            }
          } else {
            if (state.filters.sport === filterType) {
              state.filters.sport = null;
            } else {
              state.filters.sport = filterType;
            }
          }
          
          updateEmojiFilterButtons();
          saveFilters();
          renderChannels();
        }
      });
      
      elements.closeSettingsModal.addEventListener('click', closeSettingsModal);
      
      elements.darkModeToggle.addEventListener('change', function() {
        state.settings.darkMode = this.checked;
        if (this.checked) {
          document.body.classList.add('dark-mode');
        } else {
          document.body.classList.remove('dark-mode');
        }
        saveSettings();
        showNotification('Modo oscuro ' + (this.checked ? 'activado' : 'desactivado'));
      });
      
      document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function() {
          document.querySelectorAll('.color-option').forEach(opt => {
            opt.classList.remove('color-option--active');
          });
          
          this.classList.add('color-option--active');
          const color = this.dataset.color;
          state.settings.primaryColor = color;
          updatePrimaryColor(color);
          saveSettings();
          showNotification('Color principal actualizado');
        });
      });
      
      elements.importExportTabs.forEach(tab => {
        tab.addEventListener('click', function() {
          const tabName = this.dataset.tab;
          
          elements.importExportTabs.forEach(t => {
            t.classList.remove('import-export-tab--active');
          });
          this.classList.add('import-export-tab--active');
          
          elements.importExportContents.forEach(content => {
            content.classList.remove('import-export-content--active');
          });
          document.getElementById(`${tabName}Tab`).classList.add('import-export-content--active');
        });
      });
      
      elements.copyExportLinksBtn.addEventListener('click', function() {
        elements.exportLinksData.select();
        document.execCommand('copy');
        showNotification('JSON copiado al portapapeles');
      });
      
      elements.importLinksBtn.addEventListener('click', function() {
        try {
          const data = JSON.parse(elements.importLinksData.value);
          if (!Array.isArray(data)) {
            throw new Error('Formato de datos inv√°lido');
          }
          
          const normalizedData = data.map(item => ({
            id: generateShortId(),
            link: item.link,
            title: item.title || 'Sin t√≠tulo',
            webName: item.webName || null,
            deporte: item.deporte || 'Otros',
            type: item.type || 'source',
            idioma: item.idioma || 'ES',
            color: (item.color || '#2563eb').toUpperCase(),
            openInPlayer: item.openInPlayer || false,
            puntuacion: item.puntuacion || 3,
            favorito: item.favorito || false
          }));
          
          const newLinks = normalizedData.filter(newLink => 
            newLink.type === 'source' && !state.links.some(existingLink => existingLink.link === newLink.link)
          );
          
          if (newLinks.length > 0) {
            state.links = [...state.links, ...newLinks];
            saveSettings();
            renderChannels();
            closeSettingsModal();
            showNotification(`Se a√±adieron ${newLinks.length} nuevos enlaces`);
          } else {
            showNotification('No se encontraron enlaces nuevos para importar o no son de tipo "Fuente"', 'info');
          }
        } catch (e) {
          showNotification('Error al importar datos: JSON inv√°lido', 'error');
        }
      });
      
      elements.importGistBtn.addEventListener('click', importFromGist);
      
      elements.cancelImportBtn.addEventListener('click', function() {
        elements.importLinksData.value = '';
      });
      
      elements.saveEditBtn.addEventListener('click', function() {
        state.settings.editMode = false;
        state.settings.moveMode = false; // Guardar tambi√©n deshabilita el modo mover
        saveSettings();
        renderChannels();
        updateEditModeButtons();
        showNotification('Cambios guardados');
      });
      
      elements.clearAllBtn.addEventListener('click', function() {
        elements.confirmClearModal.classList.add('modal--active');
      });
      
      elements.cancelClearBtn.addEventListener('click', function() {
        elements.confirmClearModal.classList.remove('modal--active');
      });
      
      elements.confirmClearBtn.addEventListener('click', function() {
        elements.confirmClearModal.classList.remove('modal--active');
        clearAllData();
      });
      
      elements.closeEditLinkModal.addEventListener('click', closeEditLinkModal);
      elements.cancelEditLinkBtn.addEventListener('click', cancelEditLinkModal);
      
      elements.saveEditLinkBtn.addEventListener('click', saveEditedLink);
      
      elements.editRatingStars.addEventListener('click', function(e) {
        const star = e.target.closest('.star');
        if (star) {
          const value = parseInt(star.dataset.value);
          
          const stars = elements.editRatingStars.querySelectorAll('.star');
          stars.forEach((s, index) => {
            if (index < value) {
              s.classList.add('active');
            } else {
              s.classList.remove('active');
            }
          });
        }
      });

      elements.editLinkColorHex.addEventListener('input', function() {
        const hexValue = this.value;
        if (isValidHexColor(hexValue)) {
            elements.editLinkColor.value = hexValue;
        }
      });
      
      elements.editLinkColor.addEventListener('input', function() {
        elements.editLinkColorHex.value = this.value.toUpperCase();
      });
      
      window.addEventListener('scroll', checkScrollPosition);
      
      elements.scrollToTop.addEventListener('click', function() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    }

    function updateEmojiFilterButtons() {
      document.querySelectorAll('.emoji-filter-btn').forEach(btn => {
        const filterType = btn.dataset.filter;
        if (filterType === 'ES' || filterType === 'EN') {
          btn.classList.toggle('emoji-filter-btn--active', state.filters.language === filterType);
        } else {
          btn.classList.toggle('emoji-filter-btn--active', state.filters.sport === filterType);
        }
      });
    }

    function closeSettingsModal() {
      elements.settingsModal.classList.remove('modal--active');
    }

    function closeEditLinkModal() {
      elements.editLinkModal.classList.remove('modal--active');
      state.editState.isAdding = false; // Resetear el estado
      
      // Si estamos en el modal de grupos, re-renderizarlo para actualizar los enlaces
      if (elements.groupLinksModal.classList.contains('modal--active')) {
          const currentGroupCard = document.querySelector(`.channel-card[data-group-title="${elements.groupLinksModalTitle.textContent.replace('Enlaces de: ', '')}"]`);
          if (currentGroupCard) {
              // Llamar a la funci√≥n con un objeto que simula el evento de clic
              handleGroupCardClick({ target: currentGroupCard });
          }
      }
    }

    function cancelEditLinkModal() {
      closeEditLinkModal();
    }

    function shadeColor(color, percent) {
      let R = parseInt(color.substring(1,3), 16);
      let G = parseInt(color.substring(3,5), 16);
      let B = parseInt(color.substring(5,7), 16);

      R = parseInt(R * (100 + percent) / 100);
      G = parseInt(G * (100 + percent) / 100);
      B = parseInt(B * (100 + percent) / 100);

      R = (R<255)?R:255;  
      G = (G<255)?G:255;  
      B = (B<255)?B:255;  

      const RR = ((R.toString(16).length===1)?"0"+R.toString(16):R.toString(16));
      const GG = ((G.toString(16).length===1)?"0"+G.toString(16):G.toString(16));
      const BB = ((B.toString(16).length===1)?"0"+B.toString(16):B.toString(16));

      return "#"+RR+GG+BB;
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
